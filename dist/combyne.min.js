(function(a,b){typeof exports=="object"?(module.exports=b(),module.exports.compile=function(a){return function(b){return module.exports(a,b).render()}}):typeof define=="function"&&define.amd?define([],b):a.combyne=b()})(this,function(){function render(a,b,c,d){var e,f,g,h=c.pop(),i=h.captures[0];switch(h.name){case"COMMENT":lastToken==="START_EXPR"?templateStack.push("/*"):nextToken==="END_EXPR"?templateStack.push("*/"):templateStack.push("'"+d.COMMENT+"'");break;case"OTHER":lastToken==="START_PROP"?templateStack.push(i):templateStack.push("'"+i+"'")}return c.length?(lastToken=h.name,nextToken=c[0].name,render(a,b,c,d)):templateStack}function _wrapFilter(a){var b=this;return function(){return a.apply({original:b.template},arguments)}}function escDelimiter(a){return a.replace(specialCharsExp,"\\$&")}function getKeys(a){var b,c=[];for(b in a){if(!a.hasOwnProperty(b))continue;c.push(b)}return c}function extend(a){var b,c,d=0,e=arguments.length;while(++d<e){c=arguments[d];for(b in c)a[b]=c[b]}return a}function compile(stack){function func(data){var contents,tmpl="";try{with(data||{})if(contents=eval(stack.join("\n")))tmpl+=contents}catch(ex){}return tmpl}return func}function tokenizer(a,b,c){_tokens=c=c||_tokens;var d,e,f,g,h=getKeys(c),i=h.length;while(a.length)for(d=0;d<i;d++){g=h[d];if(e=c[g].exec(a))f={name:g,captures:e},a=a.replace(c[g],""),e[0]&&b.push(f)}}function main(a,b,c,d){var e,f,g,h,i,j,k,l=0,m=[],n={};f=escDelimiter(d.START_PROP),g=escDelimiter(d.END_PROP),h=escDelimiter(d.START_EXPR),i=escDelimiter(d.END_EXPR),j=escDelimiter(d.COMMENT),k=escDelimiter(d.FILTER),n.START_PROP=new RegExp("^"+f),n.END_PROP=new RegExp("^"+g),n.START_EXPR=new RegExp("^"+h),n.END_EXPR=new RegExp("^"+i),n.COMMENT=new RegExp("^"+j),n.FILTER=new RegExp("^"+k),e=[f,g,h,i,j,k].join("|"),n.WHITESPACE=/^[\ |\t|\r|\n]+/,n.OTHER=new RegExp("^((?!"+e+").)*");if(l=tokenizer(b,m,n))if(a.debug)throw new Error(l);return m.reverse(),render(a,c,m,d)}function combyne(a,b){function c(){return{_cache:{},get:function(a){return this._cache[a]},remove:function(a){delete this._cache[a]}}}if(this instanceof combyne)this.template=a,this.context=b||{},this.filters=c(),this.filters.add=function(a,b){this._cache[a]=_wrapFilter(b)},this.partials=c(),this.partials.add=function(a,b,c){this._cache[a]={template:b,context:c}};else return new combyne(a,b)}var _tokens,nextToken,lastToken,toString=Object.prototype.toString,specialCharsExp=/[\^$\\\/.*+?()[\]{}|]/g,templateStack=[];return combyne.VERSION="0.3.0",combyne.prototype={render:function(a){var b=this;b.context=a||b.context;if(!b.template||!b.context)if(b.debug)throw new Error("Missing template or context");b.delimiters=extend({},b.delimiters,{START_PROP:"{{",END_PROP:"}}",START_EXPR:"{%",END_EXPR:"%}",COMMENT:"--",FILTER:"|"});var c=main(b,b.template,b.context,b.delimiters);return templateStack=[],nextToken="",lastToken="",compile(c)(b.context)},delimiters:{}},combyne})